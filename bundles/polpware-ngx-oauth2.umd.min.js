!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/common/http"),require("@angular/core"),require("@polpware/ngx-appkit-contracts-alpha"),require("rxjs"),require("rxjs/operators"),require("angular-oauth2-oidc"),require("@angular/router"),require("@polpware/ngx-logger")):"function"==typeof define&&define.amd?define("@polpware/ngx-oauth2",["exports","@angular/common/http","@angular/core","@polpware/ngx-appkit-contracts-alpha","rxjs","rxjs/operators","angular-oauth2-oidc","@angular/router","@polpware/ngx-logger"],t):t(((e=e||self).polpware=e.polpware||{},e.polpware["ngx-oauth2"]={}),e.ng.common.http,e.ng.core,e.ngxAppkitContractsAlpha,e.rxjs,e.rxjs.operators,e.angularOauth2Oidc,e.ng.router,e.ngxLogger)}(this,(function(e,t,r,o,n,i,a,s,c){"use strict";var u=function(){function e(e,t,r,o,n,i,a){this.id=e,this.userName=t,this.fullName=r,this.email=o,this.jobTitle=n,this.phoneNumber=i,this.roles=a}return Object.defineProperty(e.prototype,"friendlyName",{get:function(){var e=this.fullName||this.userName;return this.jobTitle&&(e=this.jobTitle+" "+e),e},enumerable:!0,configurable:!0}),e}(),p=function(){function e(e,t,r,o){this.name=e,this.value=t,this.groupName=r,this.description=o}return e.viewUsersPermission="users.view",e.manageUsersPermission="users.manage",e.viewRolesPermission="roles.view",e.manageRolesPermission="roles.manage",e.assignRolesPermission="roles.assign",e}(),l=function(){function e(e,t,r,o){this.http=e,this.oauthService=t,this.clientId="quickapp_spa",this.scope="openid email phone profile offline_access roles quickapp_api",this.localStorage=o.get(),this.configurations=r.get()}return Object.defineProperty(e.prototype,"baseUrl",{get:function(){return this.configurations.baseUrl},enumerable:!0,configurable:!0}),e.prototype.loginWithPassword=function(e,r){var o=this,a=new t.HttpHeaders({"Content-Type":"application/x-www-form-urlencoded"}),s=(new t.HttpParams).append("username",e).append("password",r).append("client_id",this.clientId).append("grant_type","password").append("scope",this.scope);return this.oauthService.issuer=this.baseUrl,n.from(this.oauthService.loadDiscoveryDocument()).pipe(i.mergeMap((function(){return o.http.post(o.oauthService.tokenEndpoint,s,{headers:a})})))},e.prototype.refreshLogin=function(){var e=this,r=new t.HttpHeaders({"Content-Type":"application/x-www-form-urlencoded"}),o=(new t.HttpParams).append("refresh_token",this.refreshToken).append("client_id",this.clientId).append("grant_type","refresh_token");return this.oauthService.issuer=this.baseUrl,n.from(this.oauthService.loadDiscoveryDocument()).pipe(i.mergeMap((function(){return e.http.post(e.oauthService.tokenEndpoint,o,{headers:r})})))},Object.defineProperty(e.prototype,"accessToken",{get:function(){return this.localStorage.getData(o.DBkeys.ACCESS_TOKEN)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"accessTokenExpiryDate",{get:function(){return this.localStorage.getDataObject(o.DBkeys.TOKEN_EXPIRES_IN,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"refreshToken",{get:function(){return this.localStorage.getData(o.DBkeys.REFRESH_TOKEN)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isSessionExpired",{get:function(){return null==this.accessTokenExpiryDate||this.accessTokenExpiryDate.valueOf()<=(new Date).valueOf()},enumerable:!0,configurable:!0}),e.ɵfac=function(n){return new(n||e)(r.ɵɵinject(t.HttpClient),r.ɵɵinject(a.OAuthService),r.ɵɵinject(o.ConfigurationServiceAbstractProvider),r.ɵɵinject(o.LocalStoreManagerServiceAbstractProvider))},e.ɵprov=r.ɵɵdefineInjectable({token:e,factory:e.ɵfac,providedIn:"root"}),e}(),h=function(){function e(){}return e.prototype.urlBase64Decode=function(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("Illegal base64url string!")}return this.b64DecodeUnicode(t)},e.prototype.b64DecodeUnicode=function(e){return decodeURIComponent(Array.prototype.map.call(atob(e),(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""))},e.prototype.decodeToken=function(e){var t=e.split(".");if(3!==t.length)throw new Error("JWT must have 3 parts");var r=this.urlBase64Decode(t[1]);if(!r)throw new Error("Cannot decode the token");return JSON.parse(r)},e.prototype.getTokenExpirationDate=function(e){var t;if(!(t=this.decodeToken(e)).hasOwnProperty("exp"))return null;var r=new Date(0);return r.setUTCSeconds(t.exp),r},e.prototype.isTokenExpired=function(e,t){var r=this.getTokenExpirationDate(e);return t=t||0,null!=r&&!(r.valueOf()>(new Date).valueOf()+1e3*t)},e.ɵfac=function(t){return new(t||e)},e.ɵprov=r.ɵɵdefineInjectable({token:e,factory:e.ɵfac,providedIn:"root"}),e}(),g=function(){function e(e,t,r,o,i){this.router=e,this.oidcHelperService=t,this._logger=r,this._loginStatus=new n.Subject,this.localStorage=i.get(),this.configurations=o.get(),this.initializeLoginStatus()}return Object.defineProperty(e.prototype,"loginUrl",{get:function(){return this.configurations.loginUrl},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"homeUrl",{get:function(){return this.configurations.homeUrl},enumerable:!0,configurable:!0}),e.prototype.initializeLoginStatus=function(){var e=this;this.localStorage.getInitEvent().subscribe((function(){e.emitLoginStatus()}))},e.prototype.gotoPage=function(e,t){void 0===t&&(t=!0);var r={queryParamsHandling:t?"merge":"",preserveFragment:t};this.router.navigate([e],r)},e.prototype.gotoHomePage=function(){this.router.navigate([this.homeUrl])},e.prototype.redirectLoginUser=function(e){this._logger.debug("login redirect url is: "+this.loginRedirectUrl),this._logger.debug("home url is: "+this.homeUrl);var t=this.loginRedirectUrl&&"/"!=this.loginRedirectUrl&&this.loginRedirectUrl!=this.loginUrl?this.loginRedirectUrl:this.homeUrl;this.loginRedirectUrl=null,this._logger.debug("final redirect url is: "+t);var r=o.Utilities.splitInTwo(t,"#"),n=o.Utilities.splitInTwo(r.firstPart,"?"),i={fragment:r.secondPart};e||Object.assign(i,{queryParams:o.Utilities.getQueryParamsFromString(n.secondPart),queryParamsHandling:"merge"}),this._logger.debug("Redirection url is: "+n.firstPart),this._logger.debug("Extra parameters: "),this._logger.debug(i),this.router.navigate([n.firstPart],i)},e.prototype.redirectLogoutUser=function(){var e=this.logoutRedirectUrl?this.logoutRedirectUrl:this.loginUrl;this.logoutRedirectUrl=null,this.router.navigate([e])},e.prototype.redirectForLogin=function(e){this.loginRedirectUrl=e||this.router.url,this.router.navigate([this.loginUrl])},e.prototype.reLogin=function(){this.reLoginDelegate?this.reLoginDelegate():this.redirectForLogin()},e.prototype.refreshLogin=function(){var e=this;return this.oidcHelperService.refreshLogin().pipe(i.map((function(t){return e.processLoginResponse(t,e.rememberMe,!0)})))},e.prototype.loginWithPassword=function(e,t,r){var o=this;return this.logout(!0),this.oidcHelperService.loginWithPassword(e,t).pipe(i.map((function(e){return o.processLoginResponse(e,r)})))},e.prototype.processLoginResponse=function(e,t,r){var o=e.access_token;if(null==o)throw new Error("accessToken cannot be null");t=t||this.rememberMe;var n=e.refresh_token||this.refreshToken,i=e.expires_in,a=new Date;a.setSeconds(a.getSeconds()+i);var s=a,c=(new h).decodeToken(o),p=Array.isArray(c.permission)?c.permission:[c.permission];this.isLoggedIn||this.configurations.import(c.configuration);var l=new u(c.sub,c.name,c.fullname,c.email,c.jobtitle,c.phone_number,Array.isArray(c.role)?c.role:[c.role]);return l.isEnabled=!0,this.saveUserDetails(l,p,o,n,s,t),!0!==r&&this.emitLoginStatus(l),l},e.prototype.saveUserDetails=function(e,t,r,n,i,a){a?(this.localStorage.savePermanentData(r,o.DBkeys.ACCESS_TOKEN),this.localStorage.savePermanentData(n,o.DBkeys.REFRESH_TOKEN),this.localStorage.savePermanentData(i,o.DBkeys.TOKEN_EXPIRES_IN),this.localStorage.savePermanentData(t,o.DBkeys.USER_PERMISSIONS),this.localStorage.savePermanentData(e,o.DBkeys.CURRENT_USER)):(this.localStorage.saveSyncedSessionData(r,o.DBkeys.ACCESS_TOKEN),this.localStorage.saveSyncedSessionData(n,o.DBkeys.REFRESH_TOKEN),this.localStorage.saveSyncedSessionData(i,o.DBkeys.TOKEN_EXPIRES_IN),this.localStorage.saveSyncedSessionData(t,o.DBkeys.USER_PERMISSIONS),this.localStorage.saveSyncedSessionData(e,o.DBkeys.CURRENT_USER)),this.localStorage.savePermanentData(a,o.DBkeys.REMEMBER_ME)},e.prototype.logout=function(e){this.localStorage.deleteData(o.DBkeys.ACCESS_TOKEN),this.localStorage.deleteData(o.DBkeys.REFRESH_TOKEN),this.localStorage.deleteData(o.DBkeys.TOKEN_EXPIRES_IN),this.localStorage.deleteData(o.DBkeys.USER_PERMISSIONS),this.localStorage.deleteData(o.DBkeys.CURRENT_USER),this.configurations.clearLocalChanges(),!0!==e&&this.emitLoginStatus()},e.prototype.emitLoginStatus=function(e){var t=null!=(e||this.localStorage.getDataObject(o.DBkeys.CURRENT_USER,!1));this._loginStatus.next(t)},e.prototype.getLoginStatusEvent=function(){return this._loginStatus.asObservable()},Object.defineProperty(e.prototype,"currentUser",{get:function(){return this.localStorage.getDataObject(o.DBkeys.CURRENT_USER,!1)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"userPermissions",{get:function(){return this.localStorage.getDataObject(o.DBkeys.USER_PERMISSIONS,!1)||[]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"accessToken",{get:function(){return this.oidcHelperService.accessToken},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"accessTokenExpiryDate",{get:function(){return this.oidcHelperService.accessTokenExpiryDate},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"refreshToken",{get:function(){return this.oidcHelperService.refreshToken},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isSessionExpired",{get:function(){return this.oidcHelperService.isSessionExpired},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isLoggedIn",{get:function(){return null!=this.currentUser},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rememberMe",{get:function(){return 1==this.localStorage.getDataObject(o.DBkeys.REMEMBER_ME,!1)},enumerable:!0,configurable:!0}),e.ɵfac=function(t){return new(t||e)(r.ɵɵinject(s.Router),r.ɵɵinject(l),r.ɵɵinject(c.NgxLoggerImpl),r.ɵɵinject(o.ConfigurationServiceAbstractProvider),r.ɵɵinject(o.LocalStoreManagerServiceAbstractProvider))},e.ɵprov=r.ɵɵdefineInjectable({token:e,factory:e.ɵfac,providedIn:"root"}),e}(),f=function(){function e(e){this._authService=e}return e.prototype.canActivate=function(e,t){var r=t.url;return this.checkLogin(r)},e.prototype.canActivateChild=function(e,t){return this.canActivate(e,t)},e.prototype.canLoad=function(e){var t="/"+e.path;return this.checkLogin(t)},e.prototype.checkLogin=function(e){return!!this._authService.isLoggedIn||(this._authService.redirectForLogin(),!1)},e.ɵfac=function(t){return new(t||e)(r.ɵɵinject(g))},e.ɵprov=r.ɵɵdefineInjectable({token:e,factory:e.ɵfac,providedIn:"root"}),e}(),d=function(){function e(e,t){this.http=e,this.authService=t}return e.prototype.refreshLogin=function(){var e=this;return this.authService.refreshLogin().pipe(i.catchError((function(t){return e.handleError(t,(function(){return e.refreshLogin()}))})))},Object.defineProperty(e.prototype,"requestHeaders",{get:function(){return{headers:new t.HttpHeaders({Authorization:"Bearer "+this.authService.accessToken,"Content-Type":"application/json",Accept:"application/json, text/plain, */*"})}},enumerable:!0,configurable:!0}),e.prototype.handleError=function(e,t){var r=this;return 401==e.status?this.isRefreshingLogin?this.pauseTask(t):(this.isRefreshingLogin=!0,n.from(this.authService.refreshLogin()).pipe(i.mergeMap((function(){return r.isRefreshingLogin=!1,r.resumeTasks(!0),t()})),i.catchError((function(e){return r.isRefreshingLogin=!1,r.resumeTasks(!1),r.authService.logout(),401==e.status||e.error&&"invalid_grant"==e.error.error?n.throwError("session expired"):n.throwError("unknown refresh error ("+(e||"server error")+")")})))):e.error&&"invalid_grant"==e.error.error?(this.authService.logout(),n.throwError(e.error&&e.error.error_description?"session expired ("+e.error.error_description+")":"session expired")):n.throwError(e)},e.prototype.pauseTask=function(e){return this.taskPauser||(this.taskPauser=new n.Subject),this.taskPauser.pipe(i.switchMap((function(t){return t?e():n.throwError("session expired")})))},e.prototype.resumeTasks=function(e){var t=this;setTimeout((function(){t.taskPauser&&(t.taskPauser.next(e),t.taskPauser.complete(),t.taskPauser=null)}))},e}(),y=function(){function e(e){this._authService=e}return e.prototype.canActivate=function(e,t){return this.checkNonLogin()},e.prototype.canActivateChild=function(e,t){return this.checkNonLogin()},e.prototype.checkNonLogin=function(){return!this._authService.isLoggedIn||(this._authService.redirectLoginUser(),!1)},e.ɵfac=function(t){return new(t||e)(r.ɵɵinject(g))},e.ɵprov=r.ɵɵdefineInjectable({token:e,factory:e.ɵfac,providedIn:"root"}),e}(),S=function(){function e(){}return e.ɵmod=r.ɵɵdefineNgModule({type:e}),e.ɵinj=r.ɵɵdefineInjector({factory:function(t){return new(t||e)},providers:[],imports:[[a.OAuthModule]]}),e}();("undefined"==typeof ngJitMode||ngJitMode)&&r.ɵɵsetNgModuleScope(S,{imports:[a.OAuthModule]}),e.AuthGuard=f,e.AuthService=g,e.EndpointBase=d,e.JwtHelper=h,e.NgxOauth2Module=S,e.NonAuthGuard=y,e.OidcHelperService=l,e.Permission=p,e.User=u,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=polpware-ngx-oauth2.umd.min.js.map