!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common/http"),require("rxjs"),require("rxjs/operators"),require("@polpware/ngx-appkit-contracts-alpha"),require("angular-oauth2-oidc"),require("@angular/router")):"function"==typeof define&&define.amd?define("@polpware/ngx-oauth2",["exports","@angular/core","@angular/common/http","rxjs","rxjs/operators","@polpware/ngx-appkit-contracts-alpha","angular-oauth2-oidc","@angular/router"],t):t(((e=e||self).polpware=e.polpware||{},e.polpware["ngx-oauth2"]={}),e.ng.core,e.ng.common.http,e.rxjs,e.rxjs.operators,e.ngxAppkitContractsAlpha,e.angularOauth2Oidc,e.ng.router)}(this,(function(e,t,r,o,n,i,a,s){"use strict";var c=function(){function e(e,t,r,o,n,i,a){this.id=e,this.userName=t,this.fullName=r,this.email=o,this.jobTitle=n,this.phoneNumber=i,this.roles=a}return Object.defineProperty(e.prototype,"friendlyName",{get:function(){var e=this.fullName||this.userName;return this.jobTitle&&(e=this.jobTitle+" "+e),e},enumerable:!0,configurable:!0}),e}(),u=function(){function e(e,t,r,o){this.name=e,this.value=t,this.groupName=r,this.description=o}return e.viewUsersPermission="users.view",e.manageUsersPermission="users.manage",e.viewRolesPermission="roles.view",e.manageRolesPermission="roles.manage",e.assignRolesPermission="roles.assign",e}(),p=function(){function e(e,t,r,o){this.http=e,this.oauthService=t,this.clientId="quickapp_spa",this.scope="openid email phone profile offline_access roles quickapp_api",this.localStorage=o.get(),this.configurations=r.get()}return Object.defineProperty(e.prototype,"baseUrl",{get:function(){return this.configurations.baseUrl},enumerable:!0,configurable:!0}),e.prototype.loginWithPassword=function(e,t){var i=this,a=new r.HttpHeaders({"Content-Type":"application/x-www-form-urlencoded"}),s=(new r.HttpParams).append("username",e).append("password",t).append("client_id",this.clientId).append("grant_type","password").append("scope",this.scope);return this.oauthService.issuer=this.baseUrl,o.from(this.oauthService.loadDiscoveryDocument()).pipe(n.mergeMap((function(){return i.http.post(i.oauthService.tokenEndpoint,s,{headers:a})})))},e.prototype.refreshLogin=function(){var e=this,t=new r.HttpHeaders({"Content-Type":"application/x-www-form-urlencoded"}),i=(new r.HttpParams).append("refresh_token",this.refreshToken).append("client_id",this.clientId).append("grant_type","refresh_token");return this.oauthService.issuer=this.baseUrl,o.from(this.oauthService.loadDiscoveryDocument()).pipe(n.mergeMap((function(){return e.http.post(e.oauthService.tokenEndpoint,i,{headers:t})})))},Object.defineProperty(e.prototype,"accessToken",{get:function(){return this.localStorage.getData(i.DBkeys.ACCESS_TOKEN)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"accessTokenExpiryDate",{get:function(){return this.localStorage.getDataObject(i.DBkeys.TOKEN_EXPIRES_IN,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"refreshToken",{get:function(){return this.localStorage.getData(i.DBkeys.REFRESH_TOKEN)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isSessionExpired",{get:function(){return null==this.accessTokenExpiryDate||this.accessTokenExpiryDate.valueOf()<=(new Date).valueOf()},enumerable:!0,configurable:!0}),e.ɵfac=function(o){return new(o||e)(t.ɵɵinject(r.HttpClient),t.ɵɵinject(a.OAuthService),t.ɵɵinject(i.ConfigurationServiceAbstractProvider),t.ɵɵinject(i.LocalStoreManagerServiceAbstractProvider))},e.ɵprov=t.ɵɵdefineInjectable({token:e,factory:e.ɵfac}),e}(),l=function(){function e(){}return e.prototype.urlBase64Decode=function(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("Illegal base64url string!")}return this.b64DecodeUnicode(t)},e.prototype.b64DecodeUnicode=function(e){return decodeURIComponent(Array.prototype.map.call(atob(e),(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""))},e.prototype.decodeToken=function(e){var t=e.split(".");if(3!==t.length)throw new Error("JWT must have 3 parts");var r=this.urlBase64Decode(t[1]);if(!r)throw new Error("Cannot decode the token");return JSON.parse(r)},e.prototype.getTokenExpirationDate=function(e){var t;if(!(t=this.decodeToken(e)).hasOwnProperty("exp"))return null;var r=new Date(0);return r.setUTCSeconds(t.exp),r},e.prototype.isTokenExpired=function(e,t){var r=this.getTokenExpirationDate(e);return t=t||0,null!=r&&!(r.valueOf()>(new Date).valueOf()+1e3*t)},e.ɵfac=function(t){return new(t||e)},e.ɵprov=t.ɵɵdefineInjectable({token:e,factory:e.ɵfac}),e}(),h=function(){function e(e,t,r,n){this.router=e,this.oidcHelperService=t,this._loginStatus=new o.Subject,this.localStorage=n.get(),this.configurations=r.get(),this.initializeLoginStatus()}return Object.defineProperty(e.prototype,"loginUrl",{get:function(){return this.configurations.loginUrl},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"homeUrl",{get:function(){return this.configurations.homeUrl},enumerable:!0,configurable:!0}),e.prototype.initializeLoginStatus=function(){var e=this;this.localStorage.getInitEvent().subscribe((function(){e.emitLoginStatus()}))},e.prototype.gotoPage=function(e,t){void 0===t&&(t=!0);var r={queryParamsHandling:t?"merge":"",preserveFragment:t};this.router.navigate([e],r)},e.prototype.gotoHomePage=function(){this.router.navigate([this.homeUrl])},e.prototype.redirectLoginUser=function(){var e=this.loginRedirectUrl&&"/"!=this.loginRedirectUrl&&this.loginRedirectUrl!=this.loginUrl?this.loginRedirectUrl:this.homeUrl;this.loginRedirectUrl=null;var t=i.Utilities.splitInTwo(e,"#"),r=i.Utilities.splitInTwo(t.firstPart,"?"),o={fragment:t.secondPart,queryParams:i.Utilities.getQueryParamsFromString(r.secondPart),queryParamsHandling:"merge"};this.router.navigate([r.firstPart],o)},e.prototype.redirectLogoutUser=function(){var e=this.logoutRedirectUrl?this.logoutRedirectUrl:this.loginUrl;this.logoutRedirectUrl=null,this.router.navigate([e])},e.prototype.redirectForLogin=function(e){this.loginRedirectUrl=e||this.router.url,this.router.navigate([this.loginUrl])},e.prototype.reLogin=function(){this.reLoginDelegate?this.reLoginDelegate():this.redirectForLogin()},e.prototype.refreshLogin=function(){var e=this;return this.oidcHelperService.refreshLogin().pipe(n.map((function(t){return e.processLoginResponse(t,e.rememberMe,!0)})))},e.prototype.loginWithPassword=function(e,t,r){var o=this;return this.logout(!0),this.oidcHelperService.loginWithPassword(e,t).pipe(n.map((function(e){return o.processLoginResponse(e,r)})))},e.prototype.processLoginResponse=function(e,t,r){var o=e.access_token;if(null==o)throw new Error("accessToken cannot be null");t=t||this.rememberMe;var n=e.refresh_token||this.refreshToken,i=e.expires_in,a=new Date;a.setSeconds(a.getSeconds()+i);var s=a,u=(new l).decodeToken(o),p=Array.isArray(u.permission)?u.permission:[u.permission];this.isLoggedIn||this.configurations.import(u.configuration);var h=new c(u.sub,u.name,u.fullname,u.email,u.jobtitle,u.phone_number,Array.isArray(u.role)?u.role:[u.role]);return h.isEnabled=!0,this.saveUserDetails(h,p,o,n,s,t),!0!==r&&this.emitLoginStatus(h),h},e.prototype.saveUserDetails=function(e,t,r,o,n,a){a?(this.localStorage.savePermanentData(r,i.DBkeys.ACCESS_TOKEN),this.localStorage.savePermanentData(o,i.DBkeys.REFRESH_TOKEN),this.localStorage.savePermanentData(n,i.DBkeys.TOKEN_EXPIRES_IN),this.localStorage.savePermanentData(t,i.DBkeys.USER_PERMISSIONS),this.localStorage.savePermanentData(e,i.DBkeys.CURRENT_USER)):(this.localStorage.saveSyncedSessionData(r,i.DBkeys.ACCESS_TOKEN),this.localStorage.saveSyncedSessionData(o,i.DBkeys.REFRESH_TOKEN),this.localStorage.saveSyncedSessionData(n,i.DBkeys.TOKEN_EXPIRES_IN),this.localStorage.saveSyncedSessionData(t,i.DBkeys.USER_PERMISSIONS),this.localStorage.saveSyncedSessionData(e,i.DBkeys.CURRENT_USER)),this.localStorage.savePermanentData(a,i.DBkeys.REMEMBER_ME)},e.prototype.logout=function(e){this.localStorage.deleteData(i.DBkeys.ACCESS_TOKEN),this.localStorage.deleteData(i.DBkeys.REFRESH_TOKEN),this.localStorage.deleteData(i.DBkeys.TOKEN_EXPIRES_IN),this.localStorage.deleteData(i.DBkeys.USER_PERMISSIONS),this.localStorage.deleteData(i.DBkeys.CURRENT_USER),this.configurations.clearLocalChanges(),!0!==e&&this.emitLoginStatus()},e.prototype.emitLoginStatus=function(e){var t=null!=(e||this.localStorage.getDataObject(i.DBkeys.CURRENT_USER,!1));this._loginStatus.next(t)},e.prototype.getLoginStatusEvent=function(){return this._loginStatus.asObservable()},Object.defineProperty(e.prototype,"currentUser",{get:function(){return this.localStorage.getDataObject(i.DBkeys.CURRENT_USER,!1)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"userPermissions",{get:function(){return this.localStorage.getDataObject(i.DBkeys.USER_PERMISSIONS,!1)||[]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"accessToken",{get:function(){return this.oidcHelperService.accessToken},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"accessTokenExpiryDate",{get:function(){return this.oidcHelperService.accessTokenExpiryDate},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"refreshToken",{get:function(){return this.oidcHelperService.refreshToken},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isSessionExpired",{get:function(){return this.oidcHelperService.isSessionExpired},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isLoggedIn",{get:function(){return null!=this.currentUser},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rememberMe",{get:function(){return 1==this.localStorage.getDataObject(i.DBkeys.REMEMBER_ME,!1)},enumerable:!0,configurable:!0}),e.ɵfac=function(r){return new(r||e)(t.ɵɵinject(s.Router),t.ɵɵinject(p),t.ɵɵinject(i.ConfigurationServiceAbstractProvider),t.ɵɵinject(i.LocalStoreManagerServiceAbstractProvider))},e.ɵprov=t.ɵɵdefineInjectable({token:e,factory:e.ɵfac}),e}(),g=function(){function e(e,t){this.authService=e,this.router=t}return e.prototype.canActivate=function(e,t){var r=t.url;return this.checkLogin(r)},e.prototype.canActivateChild=function(e,t){return this.canActivate(e,t)},e.prototype.canLoad=function(e){var t="/"+e.path;return this.checkLogin(t)},e.prototype.checkLogin=function(e){return!!this.authService.isLoggedIn||(this.authService.loginRedirectUrl=e,this.router.navigate(["/login"]),!1)},e.ɵfac=function(r){return new(r||e)(t.ɵɵinject(h),t.ɵɵinject(s.Router))},e.ɵprov=t.ɵɵdefineInjectable({token:e,factory:e.ɵfac}),e}(),f=function(){function e(e,t){this.http=e,this.authService=t}return Object.defineProperty(e.prototype,"requestHeaders",{get:function(){return{headers:new r.HttpHeaders({Authorization:"Bearer "+this.authService.accessToken,"Content-Type":"application/json",Accept:"application/json, text/plain, */*"})}},enumerable:!0,configurable:!0}),e.prototype.refreshLogin=function(){var e=this;return this.authService.refreshLogin().pipe(n.catchError((function(t){return e.handleError(t,(function(){return e.refreshLogin()}))})))},e.prototype.handleError=function(e,t){var r=this;return 401==e.status?this.isRefreshingLogin?this.pauseTask(t):(this.isRefreshingLogin=!0,o.from(this.authService.refreshLogin()).pipe(n.mergeMap((function(){return r.isRefreshingLogin=!1,r.resumeTasks(!0),t()})),n.catchError((function(e){return r.isRefreshingLogin=!1,r.resumeTasks(!1),r.authService.reLogin(),401==e.status||e.error&&"invalid_grant"==e.error.error?o.throwError("session expired"):o.throwError("unknown refresh error ("+(e||"server error")+")")})))):e.error&&"invalid_grant"==e.error.error?(this.authService.reLogin(),o.throwError(e.error&&e.error.error_description?"session expired ("+e.error.error_description+")":"session expired")):o.throwError(e)},e.prototype.pauseTask=function(e){return this.taskPauser||(this.taskPauser=new o.Subject),this.taskPauser.pipe(n.switchMap((function(t){return t?e():o.throwError("session expired")})))},e.prototype.resumeTasks=function(e){var t=this;setTimeout((function(){t.taskPauser&&(t.taskPauser.next(e),t.taskPauser.complete(),t.taskPauser=null)}))},e}(),d=function(){function e(){}return e.ɵmod=t.ɵɵdefineNgModule({type:e}),e.ɵinj=t.ɵɵdefineInjector({factory:function(t){return new(t||e)},providers:[p,h,l,g],imports:[[a.OAuthModule]]}),e}();("undefined"==typeof ngJitMode||ngJitMode)&&t.ɵɵsetNgModuleScope(d,{imports:[a.OAuthModule]}),e.AuthGuard=g,e.AuthService=h,e.EndpointBase=f,e.JwtHelper=l,e.NgxOauth2Module=d,e.OidcHelperService=p,e.Permission=u,e.User=c,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=polpware-ngx-oauth2.umd.min.js.map