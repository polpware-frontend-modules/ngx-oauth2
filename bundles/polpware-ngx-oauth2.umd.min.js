!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common/http"),require("rxjs"),require("rxjs/operators"),require("angular-oauth2-oidc"),require("@polpware/ngx-appkit-contracts-alpha"),require("@angular/router")):"function"==typeof define&&define.amd?define("@polpware/ngx-oauth2",["exports","@angular/core","@angular/common/http","rxjs","rxjs/operators","angular-oauth2-oidc","@polpware/ngx-appkit-contracts-alpha","@angular/router"],t):t(((e=e||self).polpware=e.polpware||{},e.polpware["ngx-oauth2"]={}),e.ng.core,e.ng.common.http,e.rxjs,e.rxjs.operators,e.angularOauth2Oidc,e.ngxAppkitContractsAlpha,e.ng.router)}(this,(function(e,t,r,o,n,i,a,s){"use strict";var c=function(){function e(e,t,r,o,n,i,a){this.id=e,this.userName=t,this.fullName=r,this.email=o,this.jobTitle=n,this.phoneNumber=i,this.roles=a}return Object.defineProperty(e.prototype,"friendlyName",{get:function(){var e=this.fullName||this.userName;return this.jobTitle&&(e=this.jobTitle+" "+e),e},enumerable:!0,configurable:!0}),e}();var u=function(){function e(e,t,r,o){this.name=e,this.value=t,this.groupName=r,this.description=o}return e.viewUsersPermission="users.view",e.manageUsersPermission="users.manage",e.viewRolesPermission="roles.view",e.manageRolesPermission="roles.manage",e.assignRolesPermission="roles.assign",e}();var l=function(){function e(e,t,r,o){this.http=e,this.oauthService=t,this.clientId="quickapp_spa",this.scope="openid email phone profile offline_access roles quickapp_api",this.localStorage=o.get(),this.configurations=r.get()}return Object.defineProperty(e.prototype,"baseUrl",{get:function(){return this.configurations.baseUrl},enumerable:!0,configurable:!0}),e.prototype.loginWithPassword=function(e,t){var i=this,a=new r.HttpHeaders({"Content-Type":"application/x-www-form-urlencoded"}),s=(new r.HttpParams).append("username",e).append("password",t).append("client_id",this.clientId).append("grant_type","password").append("scope",this.scope);return this.oauthService.issuer=this.baseUrl,o.from(this.oauthService.loadDiscoveryDocument()).pipe(n.mergeMap((function(){return i.http.post(i.oauthService.tokenEndpoint,s,{headers:a})})))},e.prototype.refreshLogin=function(){var e=this,t=new r.HttpHeaders({"Content-Type":"application/x-www-form-urlencoded"}),i=(new r.HttpParams).append("refresh_token",this.refreshToken).append("client_id",this.clientId).append("grant_type","refresh_token");return this.oauthService.issuer=this.baseUrl,o.from(this.oauthService.loadDiscoveryDocument()).pipe(n.mergeMap((function(){return e.http.post(e.oauthService.tokenEndpoint,i,{headers:t})})))},Object.defineProperty(e.prototype,"accessToken",{get:function(){return this.localStorage.getData(a.DBkeys.ACCESS_TOKEN)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"accessTokenExpiryDate",{get:function(){return this.localStorage.getDataObject(a.DBkeys.TOKEN_EXPIRES_IN,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"refreshToken",{get:function(){return this.localStorage.getData(a.DBkeys.REFRESH_TOKEN)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isSessionExpired",{get:function(){return null==this.accessTokenExpiryDate||this.accessTokenExpiryDate.valueOf()<=(new Date).valueOf()},enumerable:!0,configurable:!0}),e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:r.HttpClient},{type:i.OAuthService},{type:a.ConfigurationServiceAbstractProvider},{type:a.LocalStoreManagerServiceAbstractProvider}]},e}();var p=function(){function e(){}return e.prototype.urlBase64Decode=function(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("Illegal base64url string!")}return this.b64DecodeUnicode(t)},e.prototype.b64DecodeUnicode=function(e){return decodeURIComponent(Array.prototype.map.call(atob(e),(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""))},e.prototype.decodeToken=function(e){var t=e.split(".");if(3!==t.length)throw new Error("JWT must have 3 parts");var r=this.urlBase64Decode(t[1]);if(!r)throw new Error("Cannot decode the token");return JSON.parse(r)},e.prototype.getTokenExpirationDate=function(e){var t;if(!(t=this.decodeToken(e)).hasOwnProperty("exp"))return null;var r=new Date(0);return r.setUTCSeconds(t.exp),r},e.prototype.isTokenExpired=function(e,t){var r=this.getTokenExpirationDate(e);return t=t||0,null!=r&&!(r.valueOf()>(new Date).valueOf()+1e3*t)},e.decorators=[{type:t.Injectable}],e}(),g=function(){function e(e,t,r,n){this.router=e,this.oidcHelperService=t,this.previousIsLoggedInCheck=!1,this._loginStatus=new o.BehaviorSubject(!1),this.localStorage=n.get(),this.configurations=r.get(),this.initializeLoginStatus()}return Object.defineProperty(e.prototype,"loginUrl",{get:function(){return this.configurations.loginUrl},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"homeUrl",{get:function(){return this.configurations.homeUrl},enumerable:!0,configurable:!0}),e.prototype.initializeLoginStatus=function(){var e=this;this.localStorage.getInitEvent().subscribe((function(){e.reevaluateLoginStatus()}))},e.prototype.gotoPage=function(e,t){void 0===t&&(t=!0);var r={queryParamsHandling:t?"merge":"",preserveFragment:t};this.router.navigate([e],r)},e.prototype.gotoHomePage=function(){this.router.navigate([this.homeUrl])},e.prototype.redirectLoginUser=function(){console.log("loginRedirectUrl 2"+this.loginRedirectUrl),console.log(this.homeUrl);var e=this.loginRedirectUrl&&"/"!=this.loginRedirectUrl&&this.loginRedirectUrl!=a.ConfigurationServiceConstants.defaultHomeUrl?this.loginRedirectUrl:this.homeUrl;this.loginRedirectUrl=null,console.log("directurl="+e);var t=a.Utilities.splitInTwo(e,"#"),r=a.Utilities.splitInTwo(t.firstPart,"?"),o={fragment:t.secondPart,queryParams:a.Utilities.getQueryParamsFromString(r.secondPart),queryParamsHandling:"merge"};this.router.navigate([r.firstPart],o)},e.prototype.redirectLogoutUser=function(){var e=this.logoutRedirectUrl?this.logoutRedirectUrl:this.loginUrl;this.logoutRedirectUrl=null,this.router.navigate([e])},e.prototype.redirectForLogin=function(){console.log("redirect for login"),this.loginRedirectUrl=this.router.url,this.router.navigate([this.loginUrl])},e.prototype.reLogin=function(){this.reLoginDelegate?this.reLoginDelegate():this.redirectForLogin()},e.prototype.refreshLogin=function(){var e=this;return this.oidcHelperService.refreshLogin().pipe(n.map((function(t){return e.processLoginResponse(t,e.rememberMe)})))},e.prototype.loginWithPassword=function(e,t,r){var o=this;return this.isLoggedIn&&this.logout(),this.oidcHelperService.loginWithPassword(e,t).pipe(n.map((function(e){return o.processLoginResponse(e,r)})))},e.prototype.processLoginResponse=function(e,t){var r=e.access_token;if(null==r)throw new Error("accessToken cannot be null");t=t||this.rememberMe;var o=e.refresh_token||this.refreshToken,n=e.expires_in,i=new Date;i.setSeconds(i.getSeconds()+n);var a=i,s=(new p).decodeToken(r),u=Array.isArray(s.permission)?s.permission:[s.permission];this.isLoggedIn||this.configurations.import(s.configuration);var l=new c(s.sub,s.name,s.fullname,s.email,s.jobtitle,s.phone_number,Array.isArray(s.role)?s.role:[s.role]);return l.isEnabled=!0,this.saveUserDetails(l,u,r,o,a,t),this.reevaluateLoginStatus(l),l},e.prototype.saveUserDetails=function(e,t,r,o,n,i){i?(this.localStorage.savePermanentData(r,a.DBkeys.ACCESS_TOKEN),this.localStorage.savePermanentData(o,a.DBkeys.REFRESH_TOKEN),this.localStorage.savePermanentData(n,a.DBkeys.TOKEN_EXPIRES_IN),this.localStorage.savePermanentData(t,a.DBkeys.USER_PERMISSIONS),this.localStorage.savePermanentData(e,a.DBkeys.CURRENT_USER)):(this.localStorage.saveSyncedSessionData(r,a.DBkeys.ACCESS_TOKEN),this.localStorage.saveSyncedSessionData(o,a.DBkeys.REFRESH_TOKEN),this.localStorage.saveSyncedSessionData(n,a.DBkeys.TOKEN_EXPIRES_IN),this.localStorage.saveSyncedSessionData(t,a.DBkeys.USER_PERMISSIONS),this.localStorage.saveSyncedSessionData(e,a.DBkeys.CURRENT_USER)),this.localStorage.savePermanentData(i,a.DBkeys.REMEMBER_ME)},e.prototype.logout=function(){this.localStorage.deleteData(a.DBkeys.ACCESS_TOKEN),this.localStorage.deleteData(a.DBkeys.REFRESH_TOKEN),this.localStorage.deleteData(a.DBkeys.TOKEN_EXPIRES_IN),this.localStorage.deleteData(a.DBkeys.USER_PERMISSIONS),this.localStorage.deleteData(a.DBkeys.CURRENT_USER),this.configurations.clearLocalChanges(),this.reevaluateLoginStatus()},e.prototype.reevaluateLoginStatus=function(e){var t=this,r=null!=(e||this.localStorage.getDataObject(a.DBkeys.CURRENT_USER,!1));this.previousIsLoggedInCheck!=r&&setTimeout((function(){t._loginStatus.next(r)})),this.previousIsLoggedInCheck=r},e.prototype.getLoginStatusEvent=function(){return this._loginStatus.asObservable()},Object.defineProperty(e.prototype,"currentUser",{get:function(){var e=this.localStorage.getDataObject(a.DBkeys.CURRENT_USER,!1);return this.reevaluateLoginStatus(e),e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"userPermissions",{get:function(){return this.localStorage.getDataObject(a.DBkeys.USER_PERMISSIONS,!1)||[]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"accessToken",{get:function(){return this.oidcHelperService.accessToken},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"accessTokenExpiryDate",{get:function(){return this.oidcHelperService.accessTokenExpiryDate},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"refreshToken",{get:function(){return this.oidcHelperService.refreshToken},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isSessionExpired",{get:function(){return this.oidcHelperService.isSessionExpired},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isLoggedIn",{get:function(){return null!=this.currentUser},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rememberMe",{get:function(){return 1==this.localStorage.getDataObject(a.DBkeys.REMEMBER_ME,!1)},enumerable:!0,configurable:!0}),e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:s.Router},{type:l},{type:a.ConfigurationServiceAbstractProvider},{type:a.LocalStoreManagerServiceAbstractProvider}]},e}();var h=function(){function e(e,t){this.authService=e,this.router=t}return e.prototype.canActivate=function(e,t){var r=t.url;return this.checkLogin(r)},e.prototype.canActivateChild=function(e,t){return this.canActivate(e,t)},e.prototype.canLoad=function(e){var t="/"+e.path;return this.checkLogin(t)},e.prototype.checkLogin=function(e){return!!this.authService.isLoggedIn||(this.authService.loginRedirectUrl=e,this.router.navigate(["/login"]),!1)},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:g},{type:s.Router}]},e}();var f=function(){function e(){}return e.decorators=[{type:t.NgModule,args:[{declarations:[],imports:[i.OAuthModule],exports:[],providers:[l,g,p,h]}]}],e}();e.AuthGuard=h,e.AuthService=g,e.JwtHelper=p,e.NgxOauth2Module=f,e.OidcHelperService=l,e.Permission=u,e.User=c,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=polpware-ngx-oauth2.umd.min.js.map